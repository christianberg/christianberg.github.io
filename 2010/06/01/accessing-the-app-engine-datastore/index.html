<!DOCTYPE html>
<html><head><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Christian Berg" name="author"><link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet"><link href="/atom.xml" rel="alternate" title="Christian Bergs Blog" type="application/atom+xml"><title>Christian Bergs Blog</title></head><body><div class="navbar navbar-default"><div class="container"><div class="navbar-header"><a class="navbar-brand" href="/" title="{:author &quot;Christian Berg&quot;
 :type :blog}">(christianberg.github.io)</a></div><a class="navbar-text navbar-right" href="/archive">Archive</a></div></div><div class="container"><h1>Accessing the App Engine Datastore</h1><p>In my <a href="/blog/2010/05/11/deploying-to-app-engine">last post</a>, I managed to deploy a Compojure app to Google App Engine. Serving static content isn't very exciting, though. Pretty much every app will need some way to store and retrieve data. So let's try to access the App Engine Datastore.</p>
<!--more--><h2>New Dependencies</h2><p>To use the datastore API I need to include a jar that comes with the GAE SDK in my app. I could call the Java API directly, but there are already a few Clojure libraries that provide friendly wrappers around it. One of the first (that I know of) was <a href="http://github.com/duelinmarkers/appengine-clj">appengine-clj</a> by John Hume (who was also one of the first to <a href="http://elhumidor.blogspot.com/2009/04/clojure-on-google-appengine.html">write about using Clojure on GAE</a>).</p><p>I decided to go with <a href="http://github.com/r0man/appengine-clj">this fork</a> of appengine-clj by Roman Scherer, which seems to be more complete and actively maintained. Another interesting option would be <a href="http://github.com/smartrevolution/clj-gae-datastore">clj-gae-datastore</a> by the people at freiheit.com.</p><p>I updated my project.clj file with the new dependencies:</p>
<pre><code class="clojure">(defproject compojureongae &quot;0.2.0&quot;
  :description &quot;Example app for deployoing Compojure on Google App Engine&quot;
  :namespaces [compojureongae.core]
  :dependencies [[compojure &quot;0.4.0-RC3&quot;]
                 [ring/ring-servlet &quot;0.2.1&quot;]
                 [hiccup &quot;0.2.4&quot;]
                 [appengine &quot;0.2&quot;]
                 [com.google.appengine/appengine-api-1.0-sdk &quot;1.3.4&quot;]]
  :dev-dependencies [[swank-clojure &quot;1.2.0&quot;]]
  :compile-path &quot;war/WEB-INF/classes&quot;
  :library-path &quot;war/WEB-INF/lib&quot;)
</code></pre><p>I'm using <a href="http://github.com/weavejester/hiccup">Hiccup</a> (formerly part of Compojure) for HTML generation. Running <code>lein deps</code> runs into an error, because it can't find the Google SDK jar in the public repositories. Luckily, Leiningen (or Maven) already tells me how to fix this by installing the jar from the SDK download into my local Maven repository - I just have to copy and paste the command from the error message and enter the path to the local jar. After that, <code>lein deps</code> executes cleanly and copies the new dependencies into my lib dir.</p><p>Along with updating the dependencies in project.clj I have to import the needed symbols into my namespace:</p>
<pre><code class="clojure">(ns compojureongae.core
  (:gen-class :extends javax.servlet.http.HttpServlet)
  (:use compojure.core
        [ring.util.servlet   :only [defservice]]
        [ring.util.response  :only [redirect]]
        [hiccup.core         :only [h html]]
        [hiccup.page-helpers :only [doctype include-css link-to xhtml-tag]]
        [hiccup.form-helpers :only [form-to text-area text-field]])
  (:import (com.google.appengine.api.datastore Query))
  (:require [compojure.route          :as route]
            [appengine.datastore.core :as ds]))

</code></pre><p>The choice of using <code>:use</code> or <code>:require</code> is pretty arbitrary in this case - I just used both to demonstrate the different options. With <code>:require</code> I need to call the functions using the full namespace (using a short alias), with <code>:use</code> they are imported into my namespace. For the latter case, I explicitly named all the definitions I need using <code>:only</code>. This is pretty verbose and not strictly necessary, but for a little howto like this I want you to immediately see where every function comes from, so you don't have to rummage through all the libraries (although the <code>doc</code> function makes this easy...). I guess it generally is a good idea to not clutter your namespace with definitions you don't need.</p><h2>Storing Data</h2><p>Now comes the more interesting part: Actually accessing the datastore. I want to be able to create simple blog posts, consisting of a title and a body. I need two new routes, one for displaying a form, and one that is used as the action URL for the form:</p>
<pre><code class="clojure">(defroutes example
  (GET &quot;/&quot; [] (main-page))
  (GET &quot;/new&quot; [] (render-page &quot;New Post&quot; new-form))
  (POST &quot;/post&quot; [title body] (create-post title body))
  (route/not-found &quot;Page not found&quot;))

</code></pre><p>Here's the code that handles the form submission:</p>
<pre><code class="clojure">(defn create-post [title body]
  &quot;Stores a new post in the datastore and issues an HTTP Redirect to the main page.&quot;
  (ds/create-entity {:kind &quot;post&quot; :title title :body body})
  (redirect &quot;/&quot;))

</code></pre><p>Amazingly simple. The <code>create-entity</code> function just takes a Clojure map, which needs to have a <code>:kind</code> entry, and stores it in the datastore. After that I issue an HTTP redirect to the main page.</p><h2>Retrieving Data</h2><p>Retrieving data is just as simple. On the main page, I just display all posts:</p>
<pre><code class="clojure">(defn render-post [post]
  &quot;Renders a post to HTML.&quot;
  [:div
   [:h2 (h (:title post))]
   [:p (h (:body post))]])

(defn get-posts []
  &quot;Returns all posts stored in the datastore.&quot;
  (ds/find-all (Query. &quot;post&quot;)))

(defn main-page []
  &quot;Renders the main page by displaying all posts.&quot;
  (render-page &quot;Compojure on GAE&quot;
    (map render-post (get-posts))))

</code></pre><p>The <code>h</code> function takes care of escaping special characters in the user input, so I don't run into any cross-site scripting trouble. <code>render-page</code> is a little helper function that takes care of constructing the common HTML around the payload for all pages.</p><p>As usual, the whole code can be found at <a href="http://github.com/christianberg/compojureongae">Github</a>. The version as of this writing is <a href="http://github.com/christianberg/compojureongae/tree/v0.2.0">here</a>.</p><h2>Basic Security</h2><p>I don't want the whole world to be able to post to my blog, so I need some authentication and authorization. I could use the App Engine Users API, but I'll leave that for a later post. Instead I'll go the simple route and enable security for some URLs in the deployment descriptor. That way the application itself is blissfully unaware of it. I just need to add this to the web.xml file:</p>
<pre><code class="xml">  &lt;security-constraint&gt;
    &lt;web-resource-collection&gt;
      &lt;url-pattern&gt;/new&lt;/url-pattern&gt;
      &lt;url-pattern&gt;/post&lt;/url-pattern&gt;
    &lt;/web-resource-collection&gt;
    &lt;auth-constraint&gt;
      &lt;role-name&gt;admin&lt;/role-name&gt;
    &lt;/auth-constraint&gt;
  &lt;/security-constraint&gt;

</code></pre><p>Now only logged-in admin users can post new entries. You can see the deployed version of the app here: <a href="http://v0-2.latest.compojureongae.appspot.com/">http://v0-2.latest.compojureongae.appspot.com/</a></p><h2>What about the REPL!?</h2><p>Okay, everything works fine. I can compile the project, start the dev_appserver to test it locally and deploy it to the Google cloud (see <a href="/blog/2010/05/11/deploying-to-app-engine">my last post</a> for the steps). But what about interactive development? When I try to call e.g. the <code>create-entity</code> function from a REPL, I only get an Exception. So I can develop and deploy working software, but I'm back to the dreaded edit-compile-run cycle - that's not the Clojure way.</p><p>I need to fix this, but it'll have to wait until the next post. Sorry...</p></div><footer><div class="container"><p class="text-muted"><small>&copy; 2009-2014 Christian Berg</small></p></div></footer><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21431349-1', 'christianberg.github.io');
  ga('send', 'pageview');
</script></body></html>