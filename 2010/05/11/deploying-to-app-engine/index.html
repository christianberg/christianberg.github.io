<!DOCTYPE html>
<html><head><meta content="width=device-width, initial-scale=1" name="viewport"><meta content="Christian Berg" name="author"><link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet"><link href="/atom.xml" rel="alternate" title="Christian Bergs Blog" type="application/atom+xml"><title>Christian Bergs Blog</title></head><body><div class="navbar navbar-default"><div class="container"><div class="navbar-header"><a class="navbar-brand" href="/" title="{:author &quot;Christian Berg&quot;
 :type :blog}">(christianberg.github.io)</a></div><a class="navbar-text navbar-right" href="/archive/">Archive</a></div></div><div class="container"><h1>Deploying to App Engine</h1><p>In my <a href="/blog/2010/05/07/a-fresh-start">last post</a>, I set up a basic Hello World Compojure app, running on a local Jetty instance. Now I want to deploy this to Google App Engine.</p>
<!--more--><h2>Creating a Servlet</h2><p>App Engine expects a standard Java web application, which means we have to take a small step out of pure Clojure-land into the Java realm and implement the HttpServlet interface. The defservice macro from the ring API makes this trivial.</p><p>Obviously, Google runs their own app servers, so we don't need to start a Jetty instance. The updated core.clj looks like this: </p>
<pre><code class="clojure">(ns compojureongae.core
  (:gen-class :extends javax.servlet.http.HttpServlet)
  (:use compojure.core
        ring.util.servlet)
  (:require [compojure.route :as route]))

(defroutes example
  (GET &quot;/&quot; [] &quot;&lt;h1&gt;Hello World Wide Web!&lt;/h1&gt;&quot;)
  (route/not-found &quot;Page not found&quot;))

(defservice example)
</code></pre><p>The project.clj file needs to be updated to reflect the changed dependencies:</p>
<pre><code class="clojure">(defproject compojureongae &quot;0.1.0&quot;
  :description &quot;Example app for deployoing Compojure on Google App Engine&quot;
  :namespaces [compojureongae.core]
  :dependencies [[compojure &quot;0.4.0-SNAPSHOT&quot;]
                 [ring/ring-servlet &quot;0.2.1&quot;]]
  :dev-dependencies [[leiningen/lein-swank &quot;1.2.0-SNAPSHOT&quot;]]
  :compile-path &quot;war/WEB-INF/classes&quot;
  :library-path &quot;war/WEB-INF/lib&quot;)
</code></pre><p>Note that I added a <code>:namespaces</code> entry. This triggers the AOT compilation of the Clojure source into Java bytecode. <strong>[Edit]</strong> I also customized some paths - more on that below. <strong>[/Edit]</strong></p><p>Google App Engine requires two config files, <code>web.xml</code> and <code>appengine-web.xml</code>. For my simple app, these are pretty straight-forward. The <code>web.xml</code> defines the mapping from URL patterns to servlet classes. Here it is: </p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;
&lt;web-app 
   xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot; 
   xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
   xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot;
   version=&quot;2.5&quot;&gt; 
  &lt;display-name&gt;Compojure on GAE&lt;/display-name&gt;
  
  &lt;servlet&gt;
    &lt;servlet-name&gt;blog&lt;/servlet-name&gt;
    &lt;servlet-class&gt;compojureongae.core&lt;/servlet-class&gt;
  &lt;/servlet&gt;

  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;blog&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
&lt;/web-app&gt;

</code></pre><p>The <code>servlet-name</code> (<code>blog</code>) is a generic identifier, you can use anything you like. The <code>servlet-class</code> needs to be the clojure namespace that implements the <code>HttpServlet</code> interface - in this case <code>compojureongae.core</code>. </p><p>In the <code>appengine-web.xml</code> we set the GAE application id and an arbitrary version string:</p>
<pre><code class="xml">&lt;appengine-web-app xmlns=&quot;http://appengine.google.com/ns/1.0&quot;&gt;
  &lt;!-- Replace this with your application id from http://appengine.google.com --&gt;
  &lt;application&gt;compojureongae&lt;/application&gt;

  &lt;version&gt;v0-1&lt;/version&gt;

&lt;/appengine-web-app&gt;

</code></pre><p>I set up a github repository for my experiments at <a href="http://github.com/christianberg/compojureongae">http://github.com/christianberg/compojureongae</a>. The code as of the time of this blog post can be found at <a href="http://github.com/christianberg/compojureongae/tree/v0.1.1">http://github.com/christianberg/compojureongae/tree/v0.1.1</a>.</p><h2>Building the war</h2><p><strong>[Update]</strong> Sometimes things are much easier than they first appear. My initial "build process" (using <a href="http://github.com/alienscience/leiningen-war">leiningen-war</a>) was way too complicated. Thanks to <a href="http://buntin.org/2010/03/02/leiningen-clojure-google-app-engine-interesting/">http://buntin.org/2010/03/02/leiningen-clojure-google-app-engine-interesting/</a> for putting me on the right track. Here's how I do it now:</p><p>The deployment artifact for GAE is a standard java war file - actually a war directory, i.e. an unzipped war file. This makes the build process pretty trivial, you just have to adhere to the standard war directory structure. This is accomplished by customizing the <code>:library-path</code> and <code>:compile-path</code> in the <code>project.clj</code> (see above). Building the project is simply done with the standard lein commands:</p>
<pre><code class="shell">lein clean
lein deps
lein compile
</code></pre><p>The current stable version of leiningen (1.1.0) mixes the dependencies and the dev-dependencies. If you don't want the dev-dependency jars included in your deployment, run this sequence of commands before deploying:</p>
<pre><code class="shell">lein clean
lein deps skip
lein compile
</code></pre><p>The development version of leiningen (1.2.0-SNAPSHOT) separates the dev-dependencies into lib/dev, so you might want to check it out. <strong>[/Update]</strong></p><p>Now we have a war directory that can be used by the scripts that come with the App Engine SDK. If you haven't yet, <a href="http://code.google.com/appengine/downloads.html#Google_App_Engine_SDK_for_Java">download</a> it now.</p><h2>Testing the war</h2><p>To make sure our war file is ok, let's test it locally. I unpacked the SDK in the directory <code>$GAESDK</code>. Here's how to start the local server:</p>
<pre><code class="shell">$GAESDK/bin/dev_appserver.sh war
</code></pre><p>You should see the familiar page at <a href="http://localhost:8080/">http://localhost:8080/</a></p><h2>Into the Cloud!</h2><p>It's time to deploy. Just run</p>
<pre><code class="shell">$GAESDK/bin/appcfg.sh update war
</code></pre><p>Enter your Google login when prompted and wait for the app to deploy. (Remember that you need to create an Application in the GAE admin dashboard first and put it's app id in the <code>appengine-web.xml</code>.)</p><p>The app is now live in the cloud. You can see my deployed version here: <a href="http://v0-1.latest.compojureongae.appspot.com/">http://v0-1.latest.compojureongae.appspot.com/</a></p><p>Have fun! If this inspires you to do your own experiments with Clojure on App Engine, leave a comment below!</p></div><footer><div class="container"><p class="text-muted"><small>&copy; 2009-2016 Christian Berg</small></p></div></footer><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21431349-1', 'christianberg.github.io');
  ga('send', 'pageview');
</script></body></html>